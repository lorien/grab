<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Spider Error Handling &#8212; Grab 1.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css?v=2bf1fcf8" />
    
    <script src="../_static/documentation_options.js?v=6efca38a"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Spider Transport" href="transport.html" />
    <link rel="prev" title="Spider Cache" href="cache.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="transport.html" title="Spider Transport"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cache.html" title="Spider Cache"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Grab 1.2.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Spider Error Handling</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="spider-error-handling">
<span id="id1"></span><h1>Spider Error Handling<a class="headerlink" href="#spider-error-handling" title="Link to this heading">¶</a></h1>
<section id="rules-of-network-request-handling">
<h2>Rules of Network Request Handling<a class="headerlink" href="#rules-of-network-request-handling" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>If request is completed successfully then the corresponding handler is called</p></li>
<li><p>If request is failed due the network error, then the task is submitted back
to the task queue</p></li>
<li><p>If the request is completed and the handler is called and failed due to any
error inside the handler then the task processing is aborted. This type of
errors is not fatal. The handler error is logged and other requests and
handlers are processed in usual way.</p></li>
</ul>
</section>
<section id="network-errors">
<h2>Network Errors<a class="headerlink" href="#network-errors" title="Link to this heading">¶</a></h2>
<p>Network error is:</p>
<ul class="simple">
<li><p>error occurred in process of data transmission to or back from the server e.g.
connection aborted, connection timeout, server does not accept connection and
so on</p></li>
<li><p>data transmission has been completed but the HTTP status of received document
differs from 2XX or from 404</p></li>
</ul>
<p>Yes, by default documents with 404 status code counts as valid! That makes
sense to me :) If that is not you want then you can configure custom rule to
mark status as valid or failed. You have two ways.</p>
<p>First way is to use <cite>valid_status</cite> argument in Task constructor. With this
argument you can only extend the default valid status. This arguments accepts
list of additional valid status codes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="s1">&#39;example&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://example.com&#39;</span><span class="p">,</span> <span class="n">valid_status</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">))</span>
</pre></div>
</div>
<p>Second way is to redefine <cite>valid_response_code</cite> method. In this way you can
implement any logic you want. Method accepts two arguments: status code and
task object. Method returns boolean value, <cite>True</cite> means that the status code
is valid:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SomeSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">valid_response_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="handling-of-failed-tasks">
<h2>Handling of Failed Tasks<a class="headerlink" href="#handling-of-failed-tasks" title="Link to this heading">¶</a></h2>
<p>The task failed due to the network error is put back to tas queue. The number
of tries is limited to the <cite>Spider.network_try_limit</cite> and is 10 by default.
The try’s number is stored in the <cite>Task.network_try_count</cite>. If
<cite>network_try_count</cite> reaches the <cite>network_try_limit</cite> the task is aborted.</p>
<p>When the task is aborted and there is method with name
<cite>task_&lt;task-name&gt;_fallback</cite> then it is called and receives the failed task as
first argument.</p>
<p>Also, it happens that you need to put task back to task queue even it was not
failed due to the network error. For example, the response contains captcha
challenge or other invalid data reasoned by the anti-scraping protection.
You can control number of such tries. Max tries number is configured by
<cite>Spider.task_try_count</cite>. The try’s number is stored in <cite>Task.task_try_count</cite>.
Keep in mind, that you have to increase <cite>task_try_count</cite> explicitly when you
put task back to task queue.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">task_google</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grab</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">captcha_found</span><span class="p">(</span><span class="n">grab</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">Task</span><span class="p">(</span><span class="s1">&#39;google&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">grab</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span>
                   <span class="n">task_try_count</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">task_try_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">task_google_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s1">&#39;Google is not happy with you IP address&#39;</span>
</pre></div>
</div>
</section>
<section id="manual-processing-of-failed-tasks">
<h2>Manual Processing of Failed Tasks<a class="headerlink" href="#manual-processing-of-failed-tasks" title="Link to this heading">¶</a></h2>
<p>You can disable default mechanism of processing failed tasks and
process failures manually. Use <cite>raw=True</cite> parameter in Task constructor.
If the network request would fail then the grab object passed to the handler
would contain information about failure in two attributes:
<cite>grab.response.error_code</cite> and <cite>grab.response.error_msg</cite></p>
<p>See example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TestSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">task_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">Task</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://example.com/&#39;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">task_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grab</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">grab</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">error_code</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Request failed. Reason: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">grab</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Request completed. HTTP code: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">grab</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="error-statistics">
<h2>Error Statistics<a class="headerlink" href="#error-statistics" title="Link to this heading">¶</a></h2>
<p>After spider has completed the work or even in the process of working you can
receive the information about number of completed requests, failed requests,
number of specific network errors with method <cite>Spider.render_stats</cite>.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Spider Error Handling</a><ul>
<li><a class="reference internal" href="#rules-of-network-request-handling">Rules of Network Request Handling</a></li>
<li><a class="reference internal" href="#network-errors">Network Errors</a></li>
<li><a class="reference internal" href="#handling-of-failed-tasks">Handling of Failed Tasks</a></li>
<li><a class="reference internal" href="#manual-processing-of-failed-tasks">Manual Processing of Failed Tasks</a></li>
<li><a class="reference internal" href="#error-statistics">Error Statistics</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="cache.html"
                          title="previous chapter">Spider Cache</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="transport.html"
                          title="next chapter">Spider Transport</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/spider/error_handling.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="transport.html" title="Spider Transport"
             >next</a> |</li>
        <li class="right" >
          <a href="cache.html" title="Spider Cache"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Grab 1.2.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Spider Error Handling</a></li> 
      </ul>
    </div>
    
    <div class="footer" role="contentinfo">
    &#169; Copyright 2013-2025, Gregory Petukhov.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
    <p style="margin-top: 0; text-align: center; font-size: 0.8em;">Developed by <a href="http://github.com/lorien">me</a></p>
    <p style="margin-top: 0; text-align: center; font-size: 0.8em;">Jut a friend of mine who does web-scrpaing too: <a href="https://www.imscraping.ninja">www.imscraping.ninja</a>.</p>

  </body>
</html>